{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}레몬::홈{% endblock title %}
{% block container %}
<style>
    select {
        -webkit-appearance:none; /* for chrome */
        -moz-appearance:none; /*for firefox*/
        appearance:none;
    }
    select::-ms-expand{
        display:none;/*for IE10,11*/
    }
    /* FOOTER에서 사용하는 CSS */

    .bottom-nav-home a{
        color: #FFD859 !important;
    }

    .bottom-nav-search-stock a,.bottom-nav-calendar a,
    .bottom-nav-stock a,.bottom-nav-addlist a,
    .bottom-nav-myinfo a{
        font-family: 'Noto Sans KR', sans-serif;
        font-weight: 500;
        font-size: 0.8rem;
        color: #D1D6DA !important;
    }
    input::placeholder {
    color: #a0a0a0;
    font-size:14px;
    line-height:16px;
    padding-bottom:3px;
    }
    canvas{
    margin: 15px auto;
    width:250px !important;
    height:250px !important;
  }
  .footer-line-home{
    width:50px;
    padding: 12px 0 10px 0;
    border-bottom: 2px solid #FFF;
    }
</style>


{% if user.u_chk == 0 %}
<style>
    #footer{
        display:none;
    }
</style>
<div id="nav" style="border-bottom: 1px solid #f1f1f1;">
    <div>
    <div style="text-align:center;">소셜로그인 추가정보 수집 안내</div>
    </div>
</div>
    <div class="signup-wrap" style="background-color: #fff;">
  <div class="signup-wrap">
    <div class="alert alert-danger" role="alert">
        <a>최초 로그인시, <strong>개인정보 수집 동의 </strong>와
        <strong>추가정보 입력</strong> 후 서비스 사용가능합니다.</a>
    </div>
    <div class="input-form col-md-12 mx-auto" style="height:100%; padding:0 20px; text-align:left;">

        <div style="width: 100%; text-align:center; margin-top:10px;">
        <!--<img src="media/LEMON_LOGO_146x40.png" style="width: 146px; height:40px;">-->
        </div>
        <form class="validation-form" method="POST" action="{% url 'calendars:home' %}" id="signup-form">
            {% csrf_token %}
            <div class="persnal_info_access" style="padding-top:10px; min-width:375px;">
                <div class="require_chk_wrap" style="margin-top: 15px;">
                    <a>개인정보 수집 동의(필수)</a><br>
                    <textarea cols="30" rows="5" style="width:100%;" disabled="disabled">{% include "persnal.html" %}</textarea><br>
                    <label style="text-align:end;">
                        <input type="checkbox" name="u_chk" value ="1" id="require_chk2">
                        <span>이용약관에 동의합니다.</span>
                    </label>
                </div>
             <div class="add_info" style="padding-top:40px;">
                 <a class="add_info_title" style="padding-top:40px;">추가 정보</a><br>
                <input id="name" name="username" type="text" class="add_info_input" value="" placeholder="이름을 입력해주세요"> <br>
                <select name="gender" class="add_info_select">
                    <option value=""> 성별을 선택해주세요 </option>
                    <option value="M"> 남자 </option>
                    <option value="F"> 여자 </option>
                </select> <br>
                <select name = job class="add_info_select">
                    <option value=""> 직업군을 선택해주세요 </option>
                    <option value="1">학생</option>
                    <option value="2">자영업자</option>
                    <option value="3">회사원</option>
                    <option value="4">의사</option>
                </select> <br>
                <input type="number" class="add_info_input" id="invest" name="invest" placeholder="모의 투자금액을 입력하세요." value=""><br>
                <input style="display: none;" type="date" class="add_info_select_signup" id="invest_date" name="invest_date" value="">
                <div style="width:100%; min-width:373px;">
                    <input class="add_info_phone" id="phonenumber" name="phonenumber" type="text" placeholder="- 를 제외하고 전화번호를 입력하세요">
                    <button type="button" id="codeBtn" class="phone_code_btn">발송</button><br>
                    <input id="inputCode" class="add_info_phonecode" type="number" placeholder="인증번호 입력" disabled> <a id="count" class="count"></a>
                    <button type="button" id="certBtn" onclick="certfun();" class="phone_code_btn" disabled >확인</button><br>
                </div>
                    <input style="margin-bottom:10px;" class="add_info_year" name = birthday type="integrity" id="year" maxlength="8" placeholder="생년월일을 입력해주세요. 예시)19801210">
                <input type="text" class="add_info_input"
                    id="pin" name="pin" placeholder="핀번호 입력해주세요." value="">
            </div>

                <button class="access_btn" id="signupBtn" type="submit" value="signup" disabled style="width:100%">레몬 시작하기</button>
            </div>
        </form>
    </div>
</div>
<script>
document.addEventListener('keydown', function(event) {
    if (event.keyCode === 13) {
        event.preventDefault();
    };
}, true);

  document.addEventListener('keydown', function(event) {
  if (event.keyCode === 13) {
    event.preventDefault();
  };
}, true);

$('#require_chk2').change(function () {
    var checked = $(this).prop('checked');
    $('input[id="require_chk2"]').prop('checked', checked);
    //$('#signupBtn').removeAttr('disabled');
    checked ? $('#signupBtn').removeAttr('disabled'):$('#signupBtn').attr('disabled','true');
});

/*
$('input[id="require_chk"]').change(function () {
    var tmpLength = $('input[id="require_chk"]').length;
    var checkedLength = $('input[id="require_chk"]:checked').length;
    var selectAll = (tmpLength == checkedLength);
    $('#all_chk').prop('checked', selectAll);
    selectAll ? $('#signupBtn').removeAttr('disabled'):$('#signupBtn').attr('disabled','true');});*/
</script>

<script>
/* 체크버튼 동의시 회원가입 버튼 활성화 스크립트 */
$('#require_chk2').change(function () {
    var checked = $(this).prop('checked');
    $('input[id="require_chk2"]').prop('checked', checked);
    //$('#signupBtn').removeAttr('disabled');
    checked ? $('#signupBtn').removeAttr('disabled'):$('#signupBtn').attr('disabled','true');
});

/* 전화번호 길이 검증 스크립트 */
document.addEventListener('keydown', function(event) {
    if (event.keyCode === 13) {
        event.preventDefault();
    };
}, true);

  document.addEventListener('keydown', function(event) {
  if (event.keyCode === 13) {
    event.preventDefault();
  };
}, true);
</script>

<script>
    document.getElementById('codeBtn').addEventListener('click', codebtn);

    KEY = undefined;
    function codebtn(){
        KEY = makeRandomNum(4);
        var timer = null;
        var isRunning = false;
        var display = $('#count');
        var leftSec = 180;
        var phoneInput = document.getElementById('phonenumber');
        if(phoneInput.value == '' || phoneInput.value == null){
            alert('휴대전화번호를 입력하세요.');
            return false;
        }
        if(phoneInput.value.length != 11){
            alert('휴대전화번호 11자리를 입력하세요.');
            return false;
        }

        if((phoneInput.value != '' || phoneInput.value != null) && phoneInput.value.length == 11 ){
            alert('입력하신 휴대번호로 인증번호를 전송하였습니다.');
            $('#inputCode').removeAttr('disabled');
            $('#certBtn').removeAttr('disabled');
            $('#codeBtn').attr('disabled',true);
            if (isRunning){
                clearInterval(timer);
                display.html("");
                startTimer(leftSec, display);
            }else{
                startTimer(leftSec, display);
            };

            $.ajax({
                type: "POST",
                url: "{% url 'calendars:ajax_sendSMS' %}",
                data: {
                    NUM: $('#phonenumber').val(),
                    KEY: KEY,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    dataType: "json",
                },
                success: function(data){
                    console.log('성공');
                },
                fail: function(data) {
                    console('실패');
                },
            });
            return 0;
        }
        else{

        }
        // 난수 설정
        function makeRandomNum(n) {
            let value = '';
            for(let i = 0; i < n; i++) {
                value += Math.floor(Math.random() * 10);
            }
            return value;
        }
    }

    function certfun() {
        if(document.querySelector("#inputCode").value == KEY){
            alert('확인되었습니다.');
            clearInterval(timer);
            $('#phonenumber').attr('disabled', true);
            $('#inputCode').attr('disabled', true);
            $('#codeBtn').attr('disabled', true);
            $('#certBtn').attr('disabled', true);
            document.querySelector("#count").style.display = "none";
        }
        else if(document.querySelector("#inputCode").value != KEY) {
            alert('인증번호가 일치하지 않습니다. 다시 확인해주세요.');
        }
        else{
            alert('알수없는 오류가 발생하였습니다. 다시 진행해주세요.');
        }
    }

    function startTimer(count, display) {
        var minutes, seconds;
        timer = setInterval(function () {
            minutes = parseInt(count / 60, 10);
            seconds = parseInt(count % 60, 10);
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            display.html(minutes + ":" + seconds);
        // 타이머 끝
        if (--count < 0) {
            clearInterval(timer);
            alert("입력시간이 초과되었습니다.");
            display.html("00:00");
            $('#certBtn').attr('disabled', true);
            $('#codeBtn').removeAttr('disabled');
            $('.btn_chk').attr("disabled","disabled");
            isRunning = false;
            }
        }, 1000);
            isRunning = true;
    }


</script>


{% else %}
<div class="home-wrap">
    <div class="home-title">
        <a><strong>{{user.username}}</strong>님의 <br><strong>소비</strong>와 <strong>투자 현황</strong></a>
    </div>

    <div class="home-chart" id="home-chart">
        <canvas id="myChart2" width="100" height="100"></canvas>
        <script>
        const ctx = document.getElementById('myChart2').getContext('2d');
        const myChart = new Chart(ctx, {
            if(data=['0','0']){
                console.log('데이터가 0');
            },
            type: 'doughnut',
            data: {
                labels: ['모의투자금액','가계부지출','가계부수입','주식수입'],
                datasets: [{
                    label: ['모의투자금액','가계부지출','가계부수입','주식수입'],
                    data: {{ Home_chartjs_data }},
                    backgroundColor: [
                        '#5989DD',
                        '#D46A84',
                        '#4ACBD7',
                        '#F3CD55',

                    ],
                    borderColor: [
                        '#5989DD',
                        '#D46A84',
                        '#4ACBD7',
                        '#F3CD55',

                    ],
                    borderWidth: 0
                }]
            },
            options: {
                //legend: { display: false },
                rotation: 1 * Math.PI,
                circumference: 1 * Math.PI
            }
        });
        </script>
    </div>

    <div class="home-spand-div">
        <div class="home-spand-title">
            <a><strong>{{month}}월</strong> 소비</a>
            <b class="home-spand-dateView" id="date_view"></b>
        </div>

        <div class="home-spand-input">
            <a>지출 {{Expenditure.amount__sum|default_if_none:'0'|intcomma}}원</a>
        </div>

        <div class="home-spand-buttons">
            <button onclick="location.href='{% url 'calendars:history' %}'" style="margin-right:15px;" class="home-spand-button">소비 내역</button>
            <button onclick="location.href='{% url 'calendars:top5' %}'" style="margin-left:15px;" class="home-spand-button">소비 분석</button>
        </div>
    </div>

    <div class="home-stock-div" style="">
        <div class="home-stock-title">
            <a>내 주식</a>
            <a class="home-spand-dateView" id="date_view2"></a>
        </div>

        <div class="home-stock-input">
            <a>{{Total_investment_amount|default_if_none:'0'|intcomma}}원</a>
        </div>

        <div class="home-stock-input2">
            <a>{{son|intcomma}}</a>
        </div>


        <div class="home-stock-buttons">
            <button style="margin-right:15px;" class="home-stock-button" onclick="location.href='{% url 'stocks:stock' %}'">보유 주식</button>
            <button style="margin-left:15px;" class="home-stock-button" onclick="location.href='{% url 'stocks:portfolio' %}'">포트폴리오</button>
        </div>

    </div>

    <div class="home-property-div" style="display:none;">
        <div class="home-property-title">
            <a>총 자산</a>
            <a style="font-size:14px; float: right;">금일기준</a>
        </div>
    </div>
</div>

<script>
    let date = new Date();
    let today = moment(date).format('YY.MM.DD');
    console.log(today);
    $('#date_view').html(today);
    $('#date_view2').html(today);
</script>

<script>
    $(document).ready(function(){
        //$('.footer-line-home').fadeIn(550);
        //document.getElementById('footer_home').src = "/media/home_active.png";
    });
</script>

{% endif %}
{% endblock container %}
